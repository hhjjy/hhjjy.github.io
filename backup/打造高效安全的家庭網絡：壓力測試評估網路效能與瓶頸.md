# 打造高效安全的家庭網絡：壓力測試評估網路效能與瓶頸

## 引言

在上一篇文章《打造高效安全的家庭網絡：從零開始學習單臂軟路由配置》中，我們介紹了如何搭建家庭網絡和伺服器網絡，通過單臂路由和虛擬網路實現網絡隔離。本文將進一步探討該網絡架構的效能，通過壓力測試來評估其性能與潛在瓶頸。

## 網路架構回顧

在進行網絡效能測試之前，讓我們簡單回顧一下當前的網絡架構：
![image](https://github.com/hhjjy/hhjjy.github.io/assets/45664168/dd35ba1d-5bab-4cb7-8009-34f7ab4dfd79)

- 192.168.0.x (ISP LAN)
  - 192.168.0.1 (ISP 路由器)
  - 192.168.0.79 (軟路由)
    - 192.168.20.1 (家庭網絡)
    - 192.168.30.1 (伺服器網絡)

### 設備和配置

1. ISP 路由器（192.168.0.1）：提供與外部網絡的連接。
2. 軟路由（192.168.0.79）：使用單臂路由技術進行內部分網。
   - 家庭網絡（192.168.20.1）：家庭內部設備的網絡。
   - 伺服器網絡（192.168.30.1）：伺服器和關鍵設備的網絡。

### 優點和缺點

#### 優點

- 成本低：不需要額外的硬件，只需配置現有的網絡設備。
- 靈活性高：可以在任何只有單網口的機器上實現。
- 可管控性強：通過軟路由和交換機可以細緻控制虛擬網絡的訪問權限和流量。

#### 缺點

- 性能瓶頸：由於是單網口實現多個區域網絡，一旦虛擬區域網絡設備的流量變大，網絡速度可能會下降。

## 測試目標

本次測試的主要目標是評估以下三個方面的網絡效能：

1. 家庭網絡與ISP LAN的傳輸速度 (192.168.0.100 -> 192.168.20.100)
2. 家庭網絡與伺服器網絡的傳輸速度 (192.168.30.101 -> 192.168.20.100)
3. 虛擬區域網路內互相的傳輸速度 (192.168.20.101 -> 192.168.20.100)

## 測試方法

測試將使用iperf3工具進行，樹莓派掛在家庭網絡下的192.168.20.100，並在此設備上運行iperf3 -s來作為服務器。測試的電腦(客戶端)分別在ISP LAN、伺服器網絡、家庭網絡下進行測試。以下是具體的測試步驟和命令：
### 伺服器端
伺服器端處於被動模式，它會等待客戶端的連接請求並響應測試數據。伺服器本身不主動發起數據傳輸，而是響應從客戶端來的請求。

```bash
iperf3 -s 
```

### 客戶端
客戶端是通過運行iperf3 -c <server_ip>命令來啟動的，-c代表客戶端模式。需要指定伺服器的IP地址以連接到伺服器端。

```bash
#!/bin/bash
# 壓力測試腳本

# 設定服務器IP
SERVER_IP="192.168.20.100"

# UDP 小包轉發測試
echo "開始UDP小包轉發測試 (64字節)"
iperf3 -c $SERVER_IP -u -b 100M -l 64

# UDP 大包轉發測試
echo "開始UDP大包轉發測試 (1500字節)"
iperf3 -c $SERVER_IP -u -b 100M -l 1500

# TCP 小包轉發測試
echo "開始TCP小包轉發測試 (64字節)"
iperf3 -c $SERVER_IP -l 64

# TCP 大包轉發測試
echo "開始TCP大包轉發測試 (1500字節)"
iperf3 -c $SERVER_IP -l 1500

```


## 測試結果

### ISP LAN 對虛擬家庭網路測試結果

| Test Type | Packet Size | Protocol | Transfer     | Bitrate         | Bandwidth Set |
|-----------|-------------|----------|--------------|-----------------|---------------|
| TCP小包轉發 | 64 bytes    | TCP      | 43.4 MBytes  | 36.4 Mbits/sec  | N/A           |
| UDP小包轉發 | 64 bytes    | UDP      | 11.9 MBytes  | 9.99 Mbits/sec  | 10M           |
| TCP大包轉發 | 1400 bytes  | TCP      | 571 MBytes   | 478 Mbits/sec   | N/A           |
| UDP大包轉發 | 1400 bytes  | UDP      | 627 MBytes   | 526 Mbits/sec   | 1000M         |

具體發送流程如下:
![image](https://github.com/hhjjy/hhjjy.github.io/assets/45664168/b5084426-807b-4a0f-9885-d90c31386342)

### 虛擬家庭網路間的傳輸測試結果

| Test Type   | Packet Size | Protocol | Transfer     | Bitrate         | Bandwidth Set |
|-------------|-------------|----------|--------------|-----------------|---------------|
| TCP小包轉發 | 64 bytes    | TCP      | 43.3 MBytes  | 36.3 Mbits/sec  | N/A           |
| UDP小包轉發 | 64 bytes    | UDP      | 11.9 MBytes  | 10.0 Mbits/sec  | 10M           |
| TCP大包轉發 | 1400 bytes  | TCP      | 413 MBytes   | 347 Mbits/sec   | N/A           |
| UDP大包轉發 | 1400 bytes  | UDP      | 1005 MBytes  | 843 Mbits/sec   | 1000M         |

具體發送流程如下:
![image](https://github.com/hhjjy/hhjjy.github.io/assets/45664168/b355648d-4f43-4779-abeb-6fa0a7a0960d)

### 虛擬家庭網路與虛擬伺服器網路傳輸測試結果（透過軟路由）

| Test Type   | Packet Size | Protocol | Transfer     | Bitrate         | Bandwidth Set |
|-------------|-------------|----------|--------------|-----------------|---------------|
| TCP小包轉發 | 64 bytes    | TCP      | 41.8 MBytes  | 35.1 Mbits/sec  | N/A           |
| UDP小包轉發 | 64 bytes    | UDP      | 11.9 MBytes  | 10.0 Mbits/sec  | 10M           |
| TCP大包轉發 | 1400 bytes  | TCP      | 590 MBytes   | 495 Mbits/sec   | N/A           |
| UDP大包轉發 | 1400 bytes  | UDP      | 980 MBytes   | 822 Mbits/sec   | 1000M         |

具體發送流程如下:
![image](https://github.com/hhjjy/hhjjy.github.io/assets/45664168/c0110e8e-bb7c-44de-8c25-216c8e18041f)

## 結果分析
#### 單一主介面re0的負載

- 主介面re0需要同時處理來自ISP LAN、虛擬家庭網路和虛擬伺服器網路的流量，這會增加其負載。
- 由於所有虛擬介面（re0.10、re0.20、re0.30）的數據都必須通過主介面re0進行處理，這樣會導致主介面的帶寬負載增加，可能會造成瓶頸。
- 在全雙工模式下，理論上re0可以同時處理1000Mbps的接收和1000Mbps的發送，但當多個高流量虛擬介面同時工作時，總負載可能會超過主介面re0的處理能力。

#### 流量競爭

- 當來自不同來源（如ISP和內部網絡）的流量同時進入和退出主介面re0時，可能會出現競爭，導致性能下降。
- 特別是在高流量場景下，如大文件傳輸或多個並發流的情況下，re0可能無法同時高效處理所有流量，導致延遲增加和吞吐量下降。

#### 回環問題

- 在虛擬家庭網路和虛擬伺服器網路之間的流量需要多次進出主介面re0，增加了數據包的處理時間和路由負擔。
- 每次數據包從虛擬介面到主介面再回到虛擬介面，這種回環會增加延遲，特別是在多次重複這個過程時。

---
## 結論
目前網絡架構中單一主介面re0承擔了來自多個虛擬介面和ISP的高負載，這是主要的瓶頸。如果能夠增加實體網口，將能有效分散流量，減少競爭，提升整體網絡性能。
希望這篇文章能幫助你更好地理解和評估家庭網絡與伺服器網絡的效能。如果你有任何問題或建議，歡迎在下方留言分享你的想法！